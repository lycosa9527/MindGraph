<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindGraph ÁÆ°ÁêÜÂêéÂè∞ | Admin Panel</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/fonts/inter.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        /* Header */
        .header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .lang-toggle {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            color: #667eea;
            transition: all 0.3s;
            font-weight: 600;
        }

        .lang-toggle:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.05);
        }

        .lang-en { display: inline; }
        .lang-zh { display: none; }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
            border: none;
            font-size: 1rem;
            font-weight: 500;
            color: #64748b;
        }

        .tab:hover {
            background: #f1f5f9;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        /* Category Collapsible Sections */
        .category-content {
            padding: 1.5rem;
            display: block;
        }
        
        .category-content.collapsed {
            display: none;
        }

        /* Log Viewer */
        .log-viewer {
            height: 600px;
            overflow-y: auto;
            background: #1e293b;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            padding: 1rem;
        }
        
        .log-line {
            margin-bottom: 0.25rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid #334155;
        }
        
        .log-timestamp {
            color: #94a3b8;
            margin-right: 0.5rem;
        }
        
        .log-level {
            font-weight: 600;
            margin-right: 0.5rem;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-size: 0.75rem;
        }
        
        .log-level-debug { background: #64748b; color: white; }
        .log-level-info { background: #0ea5e9; color: white; }
        .log-level-warning { background: #f59e0b; color: white; }
        .log-level-error { background: #ef4444; color: white; }
        .log-level-critical { background: #dc2626; color: white; }
        
        .log-module {
            color: #a78bfa;
            margin-right: 0.5rem;
            font-weight: 500;
        }
        
        .log-message {
            color: #e2e8f0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div style="display:flex;align-items:center;gap:1rem;">
            <h1>üéì MindGraph <span class="lang-zh">ÁÆ°ÁêÜÂêéÂè∞</span><span class="lang-en">Admin Panel</span></h1>
            <button class="lang-toggle" onclick="toggleLanguage()" id="langToggle">
                <span class="lang-zh">EN</span>
                <span class="lang-en">‰∏≠Êñá</span>
            </button>
        </div>
        <div class="user-info">
            <span id="adminName">Admin</span>
            <button class="btn btn-secondary btn-sm" onclick="logout()">
                <span class="lang-zh">ÁôªÂá∫</span>
                <span class="lang-en">Logout</span>
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Alert -->
        <div id="alert" class="alert"></div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä <span class="lang-zh">‰ª™Ë°®Áõò</span><span class="lang-en">Dashboard</span></button>
            <button class="tab" onclick="switchTab('schools')">üè´ <span class="lang-zh">Â≠¶Ê†°ÁÆ°ÁêÜ</span><span class="lang-en">Schools</span></button>
            <button class="tab" onclick="switchTab('users')">üë• <span class="lang-zh">Áî®Êà∑ÁÆ°ÁêÜ</span><span class="lang-en">Users</span></button>
            <button class="tab" onclick="switchTab('apikeys')">üîë <span class="lang-zh">APIÂØÜÈí•</span><span class="lang-en">API Keys</span></button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è <span class="lang-zh">Á≥ªÁªüËÆæÁΩÆ</span><span class="lang-en">Settings</span></button>
            <button class="tab" onclick="switchTab('logs')">üìã <span class="lang-zh">Ë∞ÉËØïÊó•Âøó</span><span class="lang-en">Debug Logs</span></button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3><span class="lang-zh">ÊÄªÁî®Êà∑Êï∞</span><span class="lang-en">Total Users</span></h3>
                    <div class="value" id="stat-users">-</div>
                </div>
                <div class="stat-card">
                    <h3><span class="lang-zh">Â≠¶Ê†°Êï∞Èáè</span><span class="lang-en">Organizations</span></h3>
                    <div class="value" id="stat-orgs">-</div>
                </div>
                <div class="stat-card">
                    <h3><span class="lang-zh">ÈîÅÂÆöË¥¶Êà∑</span><span class="lang-en">Locked Accounts</span></h3>
                    <div class="value" id="stat-locked">-</div>
                </div>
                <div class="stat-card">
                    <h3><span class="lang-zh">Êú¨Âë®Ê≥®ÂÜå</span><span class="lang-en">This Week</span></h3>
                    <div class="value" id="stat-recent">-</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span class="lang-zh">ÂêÑÂ≠¶Ê†°Áî®Êà∑ÂàÜÂ∏É</span><span class="lang-en">Users by Organization</span></h2>
                </div>
                <div id="org-distribution"></div>
            </div>
        </div>

        <!-- Schools Tab -->
        <div id="schools-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span class="lang-zh">Â≠¶Ê†°ÂàóË°®</span><span class="lang-en">School List</span></h2>
                    <button class="btn btn-primary" onclick="showCreateSchoolModal()">
                        ‚ûï <span class="lang-zh">ÂàõÂª∫Â≠¶Ê†°</span><span class="lang-en">Create School</span>
                    </button>
                </div>
                <div id="schools-loading" class="spinner"></div>
                <table id="schools-table" style="display:none;">
                    <thead>
                        <tr>
                            <th><span class="lang-zh">Â≠¶Ê†°‰ª£Á†Å</span><span class="lang-en">Code</span></th>
                            <th><span class="lang-zh">Â≠¶Ê†°ÂêçÁß∞</span><span class="lang-en">Name</span></th>
                            <th><span class="lang-zh">ÈÇÄËØ∑Á†Å</span><span class="lang-en">Invitation Code</span></th>
                            <th><span class="lang-zh">Âà∞ÊúüÊó•Êúü</span><span class="lang-en">Expiration</span></th>
                            <th><span class="lang-zh">Áä∂ÊÄÅ</span><span class="lang-en">Status</span></th>
                            <th><span class="lang-zh">Áî®Êà∑Êï∞</span><span class="lang-en">Users</span></th>
                            <th><span class="lang-zh">Êìç‰Ωú</span><span class="lang-en">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody id="schools-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span class="lang-zh">Áî®Êà∑ÂàóË°®</span><span class="lang-en">User List</span></h2>
                </div>
                
                <!-- Filter Controls -->
                <div style="padding:1rem;background:#f8fafc;border-bottom:1px solid #e2e8f0;">
                    <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:end;">
                        <div style="flex:1;min-width:200px;">
                            <label class="form-label" style="margin-bottom:0.25rem;"><span class="lang-zh">ÊêúÁ¥¢</span><span class="lang-en">Search</span></label>
                            <input type="text" id="user-search" class="form-input" 
                                   placeholder="Name or Phone" 
                                   onkeyup="if(event.key==='Enter') filterUsers()">
                        </div>
                        <div style="min-width:200px;">
                            <label class="form-label" style="margin-bottom:0.25rem;"><span class="lang-zh">Â≠¶Ê†°Á≠õÈÄâ</span><span class="lang-en">Filter by School</span></label>
                            <select id="user-org-filter" class="form-select" onchange="filterUsers()">
                                <option value=""><span class="lang-zh">ÂÖ®ÈÉ®Â≠¶Ê†°</span><span class="lang-en">All Schools</span></option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="filterUsers()">
                            üîç <span class="lang-zh">ÊêúÁ¥¢</span><span class="lang-en">Search</span>
                        </button>
                        <button class="btn btn-secondary" onclick="clearUserFilters()">
                            ‚Üª <span class="lang-zh">ÈáçÁΩÆ</span><span class="lang-en">Reset</span>
                        </button>
                    </div>
                </div>

                <div id="users-loading" class="spinner"></div>
                <table id="users-table" style="display:none;">
                    <thead>
                        <tr>
                            <th><span class="lang-zh">ÊâãÊú∫Âè∑</span><span class="lang-en">Phone</span></th>
                            <th><span class="lang-zh">ÂßìÂêç</span><span class="lang-en">Name</span></th>
                            <th><span class="lang-zh">Â≠¶Ê†°</span><span class="lang-en">Organization</span></th>
                            <th><span class="lang-zh">Áä∂ÊÄÅ</span><span class="lang-en">Status</span></th>
                            <th><span class="lang-zh">Êìç‰Ωú</span><span class="lang-en">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody"></tbody>
                </table>
                
                <!-- Pagination Controls -->
                <div id="users-pagination" style="display:none;padding:1rem;border-top:1px solid #e2e8f0;background:#f8fafc;">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;">
                        <div id="users-page-info" style="color:#64748b;">
                            <!-- Page info will be inserted here -->
                        </div>
                        <div style="display:flex;gap:0.5rem;">
                            <button id="users-prev-btn" class="btn btn-secondary btn-sm" onclick="previousUsersPage()">
                                ‚Üê <span class="lang-zh">‰∏ä‰∏ÄÈ°µ</span><span class="lang-en">Previous</span>
                            </button>
                            <div id="users-page-numbers" style="display:flex;gap:0.25rem;">
                                <!-- Page numbers will be inserted here -->
                            </div>
                            <button id="users-next-btn" class="btn btn-secondary btn-sm" onclick="nextUsersPage()">
                                <span class="lang-zh">‰∏ã‰∏ÄÈ°µ</span><span class="lang-en">Next</span> ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Keys Tab -->
        <div id="apikeys-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üîë <span class="lang-zh">APIÂØÜÈí•ÁÆ°ÁêÜ</span><span class="lang-en">API Keys Management</span></h2>
                    <button class="btn btn-primary" onclick="showCreateAPIKeyModal()">
                        ‚ûï <span class="lang-zh">ÂàõÂª∫ÂØÜÈí•</span><span class="lang-en">Create API Key</span>
                    </button>
                </div>
                <div id="apikeys-loading" class="spinner"></div>
                <table id="apikeys-table" style="display:none;">
                    <thead>
                        <tr>
                            <th><span class="lang-zh">ÂêçÁß∞</span><span class="lang-en">Name</span></th>
                            <th><span class="lang-zh">APIÂØÜÈí•</span><span class="lang-en">API Key</span></th>
                            <th><span class="lang-zh">‰ΩøÁî®Èáè</span><span class="lang-en">Usage</span></th>
                            <th><span class="lang-zh">Áä∂ÊÄÅ</span><span class="lang-en">Status</span></th>
                            <th><span class="lang-zh">ÂàõÂª∫Êó∂Èó¥</span><span class="lang-en">Created</span></th>
                            <th><span class="lang-zh">ÊúÄÂêé‰ΩøÁî®</span><span class="lang-en">Last Used</span></th>
                            <th><span class="lang-zh">Êìç‰Ωú</span><span class="lang-en">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody id="apikeys-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <!-- Action Bar -->
            <div class="card" style="margin-bottom:1rem;">
                <div class="card-header">
                    <h2 class="card-title"><span class="lang-zh">Á≥ªÁªüÈÖçÁΩÆ</span><span class="lang-en">System Settings</span></h2>
                    <div style="display:flex;gap:0.5rem;">
                        <button class="btn btn-secondary btn-sm" onclick="loadEnvSettings()">üîÑ <span class="lang-zh">Âà∑Êñ∞</span><span class="lang-en">Refresh</span></button>
                        <button class="btn btn-primary btn-sm" onclick="showBackupListModal()">üì¶ <span class="lang-zh">Â§á‰ªΩ</span><span class="lang-en">Backups</span></button>
                        <button class="btn btn-success btn-sm" onclick="validateEnvSettings()">‚úì <span class="lang-zh">È™åËØÅ</span><span class="lang-en">Validate</span></button>
                        <button class="btn btn-primary" onclick="saveEnvSettings()">üíæ <span class="lang-zh">‰øùÂ≠òÂÖ®ÈÉ®</span><span class="lang-en">Save All</span></button>
                    </div>
                </div>
            </div>

            <div id="settings-loading" class="spinner"></div>
            
            <div id="settings-form" style="display:none;">
                <!-- Category 1: Application Server -->
                <div class="card">
                    <div class="card-header" style="cursor:pointer;" onclick="toggleCategory('app-settings')">
                        <h3 class="card-title" style="font-size:1.1rem;">üñ•Ô∏è Application Server</h3>
                        <span id="app-settings-icon">‚ñº</span>
                    </div>
                    <div id="app-settings-content" class="category-content">
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">HOST <span style="color:#94a3b8;font-size:0.85rem;">(Server host address)</span></label>
                                <input type="text" id="env-HOST" class="form-input" placeholder="0.0.0.0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">PORT <span style="color:#94a3b8;font-size:0.85rem;">(1-65535)</span></label>
                                <input type="number" id="env-PORT" class="form-input" min="1" max="65535" placeholder="9527">
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">DEBUG <span style="color:#94a3b8;font-size:0.85rem;">(Enable debug mode)</span></label>
                                <select id="env-DEBUG" class="form-select">
                                    <option value="False">False</option>
                                    <option value="True">True</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">EXTERNAL_HOST <span style="color:#94a3b8;font-size:0.85rem;">(Public IP, optional)</span></label>
                                <input type="text" id="env-EXTERNAL_HOST" class="form-input" placeholder="Leave empty for auto-detect">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Category 2: Qwen API -->
                <div class="card">
                    <div class="card-header" style="cursor:pointer;" onclick="toggleCategory('qwen-settings')">
                        <h3 class="card-title" style="font-size:1.1rem;">ü§ñ Qwen API Configuration</h3>
                        <span id="qwen-settings-icon">‚ñº</span>
                    </div>
                    <div id="qwen-settings-content" class="category-content">
                        <div class="form-group">
                            <label class="form-label">QWEN_API_KEY <span style="color:#ef4444;">*Required</span></label>
                            <input type="password" id="env-QWEN_API_KEY" class="form-input" placeholder="sk-...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">QWEN_API_URL</label>
                            <input type="text" id="env-QWEN_API_URL" class="form-input" placeholder="https://dashscope.aliyuncs.com/...">
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">QWEN_MODEL_CLASSIFICATION <span style="color:#94a3b8;font-size:0.85rem;">(Fast/cheap)</span></label>
                                <input type="text" id="env-QWEN_MODEL_CLASSIFICATION" class="form-input" placeholder="qwen-turbo">
                            </div>
                            <div class="form-group">
                                <label class="form-label">QWEN_MODEL_GENERATION <span style="color:#94a3b8;font-size:0.85rem;">(High quality)</span></label>
                                <input type="text" id="env-QWEN_MODEL_GENERATION" class="form-input" placeholder="qwen-plus">
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">QWEN_TEMPERATURE <span style="color:#94a3b8;font-size:0.85rem;">(0.0-2.0)</span></label>
                                <input type="number" id="env-QWEN_TEMPERATURE" class="form-input" step="0.1" min="0" max="2" placeholder="0.7">
                            </div>
                            <div class="form-group">
                                <label class="form-label">LLM_TEMPERATURE <span style="color:#94a3b8;font-size:0.85rem;">(Diagram gen, 0.0-2.0)</span></label>
                                <input type="number" id="env-LLM_TEMPERATURE" class="form-input" step="0.1" min="0" max="2" placeholder="0.3">
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">QWEN_MAX_TOKENS</label>
                                <input type="number" id="env-QWEN_MAX_TOKENS" class="form-input" min="1" placeholder="1000">
                            </div>
                            <div class="form-group">
                                <label class="form-label">QWEN_TIMEOUT <span style="color:#94a3b8;font-size:0.85rem;">(seconds, 5-120)</span></label>
                                <input type="number" id="env-QWEN_TIMEOUT" class="form-input" min="5" max="120" placeholder="40">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Category 3: Logging & Features -->
                <div class="card">
                    <div class="card-header" style="cursor:pointer;" onclick="toggleCategory('misc-settings')">
                        <h3 class="card-title" style="font-size:1.1rem;">‚öôÔ∏è Logging & Feature Flags</h3>
                        <span id="misc-settings-icon">‚ñº</span>
                    </div>
                    <div id="misc-settings-content" class="category-content">
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">LOG_LEVEL</label>
                                <select id="env-LOG_LEVEL" class="form-select">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO">INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="CRITICAL">CRITICAL</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">VERBOSE_LOGGING</label>
                                <select id="env-VERBOSE_LOGGING" class="form-select">
                                    <option value="False">False</option>
                                    <option value="True">True</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">FEATURE_LEARNING_MODE</label>
                                <select id="env-FEATURE_LEARNING_MODE" class="form-select">
                                    <option value="False">Disabled</option>
                                    <option value="True">Enabled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">FEATURE_THINKGUIDE</label>
                                <select id="env-FEATURE_THINKGUIDE" class="form-select">
                                    <option value="False">Disabled</option>
                                    <option value="True">Enabled</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">FEATURE_MINDMATE</label>
                                <select id="env-FEATURE_MINDMATE" class="form-select">
                                    <option value="False">Disabled</option>
                                    <option value="True">Enabled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">FEATURE_VOICE_AGENT</label>
                                <select id="env-FEATURE_VOICE_AGENT" class="form-select">
                                    <option value="False">Disabled</option>
                                    <option value="True">Enabled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Category 4: Authentication -->
                <div class="card">
                    <div class="card-header" style="cursor:pointer;" onclick="toggleCategory('auth-settings')">
                        <h3 class="card-title" style="font-size:1.1rem;">üîê Authentication & Security</h3>
                        <span id="auth-settings-icon">‚ñº</span>
                    </div>
                    <div id="auth-settings-content" class="category-content">
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">AUTH_MODE</label>
                                <select id="env-AUTH_MODE" class="form-select">
                                    <option value="standard">Standard</option>
                                    <option value="enterprise">Enterprise</option>
                                    <option value="demo">Demo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">JWT_EXPIRY_HOURS <span style="color:#94a3b8;font-size:0.85rem;">(hours)</span></label>
                                <input type="number" id="env-JWT_EXPIRY_HOURS" class="form-input" min="1" max="168" placeholder="24">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ADMIN_PHONES <span style="color:#94a3b8;font-size:0.85rem;">(Comma-separated)</span></label>
                            <input type="text" id="env-ADMIN_PHONES" class="form-input" placeholder="13800000000,13900000000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">INVITATION_CODES <span style="color:#94a3b8;font-size:0.85rem;">(ORG:CODE:DATE,ORG2:CODE2:DATE2)</span></label>
                            <textarea id="env-INVITATION_CODES" class="form-textarea" rows="3" placeholder="DEMO-001:DEMO2024:2025-12-31"></textarea>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">DEMO_PASSKEY <span style="color:#94a3b8;font-size:0.85rem;">(6 digits)</span></label>
                                <input type="text" id="env-DEMO_PASSKEY" class="form-input" maxlength="6" placeholder="888888">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ADMIN_DEMO_PASSKEY <span style="color:#94a3b8;font-size:0.85rem;">(6 digits)</span></label>
                                <input type="text" id="env-ADMIN_DEMO_PASSKEY" class="form-input" maxlength="6" placeholder="999999">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Warnings & Actions -->
                <div class="alert alert-warning show">
                    ‚ö†Ô∏è <strong>Important:</strong> Server restart required for changes to take effect!<br>
                    ‰øÆÊîπÈÖçÁΩÆÂêéÈúÄË¶ÅÈáçÂêØÊúçÂä°Âô®ÊâçËÉΩÁîüÊïàÔºÅ
                </div>

                <div style="display:flex;gap:1rem;">
                    <button class="btn btn-primary" onclick="saveEnvSettings()">üíæ Save All Settings</button>
                    <button class="btn btn-secondary" onclick="loadEnvSettings()">‚Üª Reset to Current</button>
                </div>
            </div>
        </div>

        <!-- Debug Logs Tab -->
        <div id="logs-tab" class="tab-content">
            <div class="card" style="margin-bottom:1rem;">
                <div class="card-header">
                    <h2 class="card-title">üìã <span class="lang-zh">Ë∞ÉËØïÊó•Âøó</span><span class="lang-en">Debug Logs</span></h2>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                        <select id="log-source-select" class="form-select" style="width:auto;" onchange="logViewer.setSource(this.value)">
                            <option value="app">Application</option>
                            <option value="uvicorn">Uvicorn</option>
                            <option value="error">Errors</option>
                        </select>
                        <select id="log-level-filter" class="form-select" style="width:auto;" onchange="logViewer.setFilterLevel(this.value)">
                            <option value="ALL">All Levels</option>
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                            <option value="CRITICAL">CRITICAL</option>
                        </select>
                        <button id="stream-toggle-btn" class="btn btn-success btn-sm" onclick="toggleLogStream()">‚ñ∂ Start Stream</button>
                        <button id="autoscroll-toggle-btn" class="btn btn-secondary btn-sm" onclick="logViewer.toggleAutoScroll()">üìú Auto-scroll: ON</button>
                        <button class="btn btn-secondary btn-sm" onclick="logViewer.clearLogs()">üóëÔ∏è Clear</button>
                        <button class="btn btn-primary btn-sm" onclick="logViewer.downloadLogs()">üíæ Download</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="padding:1rem;border-bottom:1px solid #e2e8f0;">
                    <div style="display:flex;gap:0.5rem;">
                        <input type="text" id="log-search-input" class="form-input" 
                               placeholder="Search logs (press Enter)..." 
                               onkeypress="if(event.key==='Enter') performLogSearch()"
                               style="flex:1;">
                        <button class="btn btn-primary" onclick="performLogSearch()">üîç Search</button>
                        <button class="btn btn-secondary" onclick="clearLogSearch()">‚úï Clear</button>
                    </div>
                    <div id="search-results-count" style="display:none;margin-top:0.5rem;color:#64748b;font-size:0.9rem;"></div>
                </div>
                
                <div id="log-viewer-content" class="log-viewer"></div>
            </div>
        </div>
    </div>

    <!-- Backup List Modal -->
    <div id="backup-list-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üì¶ .env Backup Files</h3>
                <span class="close" onclick="closeModal('backup-list-modal')">&times;</span>
            </div>
            <div id="backup-list-loading" class="spinner"></div>
            <div id="backup-list-content" style="display:none;">
                <table style="width:100%;">
                    <thead>
                        <tr>
                            <th>Backup File</th>
                            <th>Created</th>
                            <th>Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="backup-list-tbody"></tbody>
                </table>
                <p id="no-backups-message" style="display:none;color:#64748b;text-align:center;padding:2rem;">
                    No backup files found. Backups are created automatically when you save settings.
                </p>
            </div>
        </div>
    </div>

    <!-- Create School Modal -->
    <div id="create-school-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><span class="lang-zh">ÂàõÂª∫Â≠¶Ê†°</span><span class="lang-en">Create School</span></h3>
                <span class="close" onclick="closeModal('create-school-modal')">&times;</span>
            </div>
            <div class="form-group">
                <label class="form-label"><span class="lang-zh">Â≠¶Ê†°ÂêçÁß∞</span><span class="lang-en">School Name</span> *</label>
                <input type="text" id="new-school-name" class="form-input" 
                       placeholder="Beijing High School Âåó‰∫¨È´ò‰∏≠" 
                       oninput="autoGenerateSchoolCode()" required>
                <small style="color:#64748b;">Enter the school name first, code will be generated automatically</small>
            </div>
            <div class="form-group">
                <label class="form-label"><span class="lang-zh">Â≠¶Ê†°‰ª£Á†Å</span><span class="lang-en">School Code</span> *</label>
                <div style="display:flex;gap:0.5rem;">
                    <input type="text" id="new-school-code" class="form-input" 
                           placeholder="AUTO-GENERATED" required
                           style="flex:1;background:#f8fafc;">
                    <button type="button" class="btn btn-secondary" onclick="regenerateSchoolCode()" title="Regenerate Code">
                        üîÑ
                    </button>
                </div>
                <small style="color:#64748b;">Auto-generated from school name (editable, click üîÑ to regenerate)</small>
            </div>
            <div style="padding:1rem;background:#f8fafc;border-radius:8px;margin-bottom:1rem;">
                <small style="color:#64748b;">
                    ‚ÑπÔ∏è <strong>Note:</strong> Invitation code will be automatically generated after creation
                </small>
            </div>
            <button class="btn btn-primary" onclick="createSchool()"><span class="lang-zh">ÂàõÂª∫</span><span class="lang-en">Create</span></button>
        </div>
    </div>

    <!-- Edit School Modal -->
    <div id="edit-school-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><span class="lang-zh">ÁºñËæëÂ≠¶Ê†°</span><span class="lang-en">Edit School</span></h3>
                <span class="close" onclick="closeModal('edit-school-modal')">&times;</span>
            </div>
            <input type="hidden" id="edit-school-id">
            <div class="form-group">
                <label class="form-label"><span class="lang-zh">Â≠¶Ê†°‰ª£Á†Å</span><span class="lang-en">School Code</span></label>
                <input type="text" id="edit-school-code" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label"><span class="lang-zh">Â≠¶Ê†°ÂêçÁß∞</span><span class="lang-en">School Name</span></label>
                <input type="text" id="edit-school-name" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label"><span class="lang-zh">ÈÇÄËØ∑Á†Å</span><span class="lang-en">Invitation Code</span></label>
                <input type="text" id="edit-school-invite" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label"><span class="lang-zh">ÊúçÂä°Âà∞ÊúüÊó•Êúü</span><span class="lang-en">Service Expiration Date</span></label>
                <input type="date" id="edit-school-expires" class="form-input">
                <small style="color:#64748b;"><span class="lang-zh">ÁïôÁ©∫Ë°®Á§∫Ê∞∏‰πÖÊúâÊïà</span><span class="lang-en">Leave empty for no expiration</span></small>
            </div>
            <div class="form-group">
                <label class="form-label"><span class="lang-zh">Ë¥¶Êà∑Áä∂ÊÄÅ</span><span class="lang-en">Account Status</span></label>
                <select id="edit-school-active" class="form-select">
                    <option value="true"><span class="lang-zh">ÊøÄÊ¥ª</span><span class="lang-en">Active</span></option>
                    <option value="false"><span class="lang-zh">ÈîÅÂÆö</span><span class="lang-en">Locked</span></option>
                </select>
                <small style="color:#64748b;"><span class="lang-zh">ÈîÅÂÆöÂêéËØ•ÁªÑÁªáÁöÑÊâÄÊúâÁî®Êà∑Â∞ÜÊó†Ê≥ïÁôªÂΩï</span><span class="lang-en">Locked organizations cannot login</span></small>
            </div>
            <div style="display:flex; gap:0.5rem; align-items:center;">
                <button class="btn btn-secondary" onclick="regenerateInviteCode()"><span class="lang-zh">ÈáçÊñ∞ÁîüÊàê</span><span class="lang-en">Regenerate</span></button>
                <button class="btn btn-primary" onclick="updateSchool()"><span class="lang-zh">‰øùÂ≠ò</span><span class="lang-en">Save</span></button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><span class="lang-zh">ÁºñËæëÁî®Êà∑</span><span class="lang-en">Edit User</span></h3>
                <span class="close" onclick="closeModal('edit-user-modal')">&times;</span>
            </div>
            <input type="hidden" id="edit-user-id">
            <div class="form-group">
                <label class="form-label"><span class="lang-zh">ÊâãÊú∫Âè∑</span><span class="lang-en">Phone Number</span> *</label>
                <input type="tel" id="edit-user-phone" class="form-input" 
                       placeholder="13812345678" maxlength="11" required>
                <small style="color:#64748b;">11-digit Chinese mobile number</small>
            </div>
            <div class="form-group">
                <label class="form-label"><span class="lang-zh">ÂßìÂêç</span><span class="lang-en">Name</span> *</label>
                <input type="text" id="edit-user-name" class="form-input" 
                       placeholder="Zhang Wei" required>
                <small style="color:#64748b;">At least 2 characters, no numbers</small>
            </div>
            <div class="form-group">
                <label class="form-label"><span class="lang-zh">Â≠¶Ê†°</span><span class="lang-en">School</span> *</label>
                <select id="edit-user-org" class="form-select" required>
                    <option value="">Loading...</option>
                </select>
            </div>
            <div style="display:flex;gap:0.5rem;align-items:center;">
                <button class="btn btn-primary" onclick="updateUser()">üíæ <span class="lang-zh">‰øùÂ≠ò</span><span class="lang-en">Save</span></button>
                <button class="btn btn-warning" onclick="resetPasswordFromModal()">üîë <span class="lang-zh">ÈáçÁΩÆÂØÜÁ†Å‰∏∫ 12345678</span><span class="lang-en">Reset Password to 12345678</span></button>
            </div>
        </div>
    </div>

    <!-- Create API Key Modal -->
    <div id="create-apikey-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üîë Create API Key</h3>
                <span class="close" onclick="closeModal('create-apikey-modal')">&times;</span>
            </div>
            <div class="form-group">
                <label class="form-label">Name *</label>
                <input type="text" id="new-apikey-name" class="form-input" 
                       placeholder="Dify Integration, Mobile App, etc." required>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="new-apikey-description" class="form-textarea" style="min-height:80px;"
                          placeholder="Purpose of this API key..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Quota Limit (leave empty for unlimited)</label>
                <input type="number" id="new-apikey-quota" class="form-input" 
                       placeholder="10000">
            </div>
            <div class="form-group">
                <label class="form-label">Expires in (days, optional)</label>
                <input type="number" id="new-apikey-expires" class="form-input" 
                       placeholder="365">
            </div>
            <button class="btn btn-primary" onclick="createAPIKey()">üîë Generate API Key</button>
        </div>
    </div>

    <!-- Show API Key Modal -->
    <div id="show-apikey-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚úÖ API Key Created</h3>
                <span class="close" onclick="closeModal('show-apikey-modal')">&times;</span>
            </div>
            <div class="alert alert-warning show">
                ‚ö†Ô∏è <strong>Important:</strong> Save this key securely - it won't be shown again!
            </div>
            <div class="form-group">
                <label class="form-label">API Key</label>
                <input type="text" id="generated-apikey" class="form-input" readonly 
                       style="font-family:monospace;font-size:0.875rem;" onclick="this.select()">
            </div>
            <div class="form-group">
                <label class="form-label">Usage Instructions</label>
                <textarea readonly class="form-textarea" style="min-height:100px;">Add this header to your HTTP requests:
X-API-Key: [your-key-here]

Example (curl):
curl -X POST http://your-server/api/generate_graph \
  -H "X-API-Key: [your-key]" \
  -H "Content-Type: application/json" \
  -d '{"prompt":"test","diagram_type":"mind_map"}'</textarea>
            </div>
            <button class="btn btn-primary" onclick="copyAPIKey()">üìã Copy to Clipboard</button>
        </div>
    </div>

    <!-- Edit API Key Modal -->
    <div id="edit-apikey-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚úèÔ∏è Edit API Key</h3>
                <span class="close" onclick="closeModal('edit-apikey-modal')">&times;</span>
            </div>
            <input type="hidden" id="edit-apikey-id">
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" id="edit-apikey-name" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="edit-apikey-description" class="form-textarea" style="min-height:80px;"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Quota Limit (empty for unlimited)</label>
                <input type="number" id="edit-apikey-quota" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Usage Count (reset to 0 if needed)</label>
                <input type="number" id="edit-apikey-usage" class="form-input">
            </div>
            <button class="btn btn-primary" onclick="updateAPIKey()">üíæ Save Changes</button>
        </div>
    </div>

    <!-- Unauthenticated Overlay -->
    <div id="auth-required-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; border-radius:20px; padding:3rem; text-align:center; max-width:500px; box-shadow:0 20px 60px rgba(0,0,0,0.5);">
            <div style="font-size:4rem; margin-bottom:1rem;">üîí</div>
            <h2 style="font-size:1.75rem; margin-bottom:1rem; color:#1e293b;">Admin Authentication Required</h2>
            <p style="color:#64748b; margin-bottom:2rem;">Please authenticate to access the admin panel</p>
            
            <div style="display:grid; gap:1rem;">
                <a href="/auth?redirect=/admin" class="btn btn-primary" style="display:block; text-decoration:none; padding:1rem;">
                    üîê Standard Login / Ê†áÂáÜÁôªÂΩï
                </a>
                <a href="/demo?redirect=/admin" class="btn btn-secondary" style="display:block; text-decoration:none; padding:1rem;">
                    üéØ Demo Mode / ÊºîÁ§∫Ê®°Âºè
                </a>
            </div>
            
            <p style="color:#94a3b8; font-size:0.875rem; margin-top:1.5rem;">
                Admins can access this panel from any authentication mode
            </p>
        </div>
    </div>

    <script src="/static/js/auth-helper.js"></script>
    <script>
        // Check admin access without automatic redirect
        async function checkAdminAuth() {
            const authenticated = await auth.isAuthenticated();
            if (!authenticated) {
                // Show overlay instead of redirecting
                document.getElementById('auth-required-overlay').style.display = 'flex';
                return false;
            }
            
            // Verify user is admin
            try {
                const response = await auth.fetch('/api/auth/me');
                const user = await response.json();
                
                // Check if user is admin by making a test admin API call
                const adminCheck = await auth.fetch('/api/auth/admin/stats');
                if (!adminCheck.ok) {
                    // User is authenticated but not admin
                    alert('‚ö†Ô∏è Admin access denied.\n\nÊÇ®‰∏çÊòØÁÆ°ÁêÜÂëòÔºåÊó†Ê≥ïËÆøÈóÆÊ≠§È°µÈù¢„ÄÇ\nYou are not an administrator and cannot access this page.');
                    window.location.href = '/editor';
                    return false;
                }
                
                // Update admin name in header
                document.getElementById('adminName').textContent = user.name || 'Admin';
                
                return true;
            } catch (error) {
                console.error('Admin check failed:', error);
                document.getElementById('auth-required-overlay').style.display = 'flex';
                return false;
            }
        }
        
        // Global state (must be declared before functions use them)
        let currentTab = 'dashboard';
        let schools = [];
        let users = [];
        let currentLang = 'en'; // Default to English
        
        // User pagination state
        let usersCurrentPage = 1;
        let usersPageSize = 50;
        let usersTotalPages = 1;
        let usersTotal = 0;

        // Check on page load
        checkAdminAuth();
        
        // Initialize language
        initLanguage();

        // Toggle language between Chinese and English
        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            
            // Update all elements with lang classes
            if (currentLang === 'zh') {
                document.querySelectorAll('.lang-zh').forEach(el => el.style.display = 'inline');
                document.querySelectorAll('.lang-en').forEach(el => el.style.display = 'none');
            } else {
                document.querySelectorAll('.lang-zh').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.lang-en').forEach(el => el.style.display = 'inline');
            }
            
            // Save language preference
            localStorage.setItem('adminLanguage', currentLang);
        }

        // Initialize language on page load
        function initLanguage() {
            const savedLang = localStorage.getItem('adminLanguage');
            if (savedLang) {
                currentLang = savedLang;
            }
            
            // Apply the language display settings
            if (currentLang === 'zh') {
                document.querySelectorAll('.lang-zh').forEach(el => el.style.display = 'inline');
                document.querySelectorAll('.lang-en').forEach(el => el.style.display = 'none');
            } else {
                document.querySelectorAll('.lang-zh').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.lang-en').forEach(el => el.style.display = 'inline');
            }
        }

        // Tab switching
        function switchTab(tab) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
            currentTab = tab;

            // Load data
            if (tab === 'dashboard') loadDashboard();
            if (tab === 'schools') loadSchools();
            if (tab === 'users') {
                loadUserFilters(); // Load filter dropdown options
                loadUsers(); // Load user list
            }
            if (tab === 'apikeys') loadAPIKeys();
            if (tab === 'settings') loadEnvSettings();
            if (tab === 'logs') initLogViewer();
        }

        // Show alert
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        // Modal functions
        function showCreateSchoolModal() {
            // Clear form first
            document.getElementById('new-school-name').value = '';
            document.getElementById('new-school-code').value = '';
            document.getElementById('create-school-modal').classList.add('show');
        }

        function openModal(id) {
            document.getElementById(id).classList.add('show');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // Auto-generate school code from school name
        function autoGenerateSchoolCode() {
            const nameInput = document.getElementById('new-school-name');
            const codeInput = document.getElementById('new-school-code');
            const name = nameInput.value.trim();
            
            if (!name) {
                codeInput.value = '';
                return;
            }
            
            // Extract English letters and Chinese characters
            const letters = name.match(/[A-Za-z]+/g) || [];
            const chinese = name.match(/[\u4e00-\u9fa5]+/g) || [];
            
            let prefix = '';
            
            // Prefer English letters for code generation
            if (letters.length > 0) {
                prefix = letters.join('').toUpperCase();
            } else if (chinese.length > 0) {
                // Use first letter of Chinese pinyin or just use first character
                // For simplicity, we'll just use "SCHOOL" as fallback
                prefix = 'SCHOOL';
            }
            
            // Take first 2-4 letters for prefix
            prefix = prefix.substring(0, Math.min(prefix.length, 4));
            if (prefix.length < 2) prefix = prefix.padEnd(2, 'X');
            
            // Add random suffix with timestamp component for uniqueness
            const timestamp = Date.now().toString().slice(-3);
            const randomChars = Math.random().toString(36).substring(2, 5).toUpperCase();
            
            codeInput.value = `${prefix}-${randomChars}${timestamp}`;
        }
        
        // Regenerate school code manually
        function regenerateSchoolCode() {
            const nameInput = document.getElementById('new-school-name');
            const codeInput = document.getElementById('new-school-code');
            const name = nameInput.value.trim();
            
            if (!name) {
                showAlert('ËØ∑ÂÖàËæìÂÖ•Â≠¶Ê†°ÂêçÁß∞ Please enter school name first', 'error');
                return;
            }
            
            // Generate with different random seed
            autoGenerateSchoolCode();
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const response = await auth.fetch('/api/auth/admin/stats');
                const stats = await response.json();

                document.getElementById('stat-users').textContent = stats.total_users;
                document.getElementById('stat-orgs').textContent = stats.total_organizations;
                document.getElementById('stat-locked').textContent = stats.locked_users;
                document.getElementById('stat-recent').textContent = stats.recent_registrations;

                // Organization distribution
                const dist = document.getElementById('org-distribution');
                dist.innerHTML = Object.entries(stats.users_by_org)
                    .map(([org, count]) => `
                        <div style="display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid #e2e8f0;">
                            <span>${org}</span>
                            <span style="font-weight:600;color:#667eea;">${count} Áî®Êà∑</span>
                        </div>
                    `).join('');
            } catch (error) {
                showAlert('Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥• Failed to load stats', 'error');
            }
        }

        // Schools
        async function loadSchools() {
            document.getElementById('schools-loading').style.display = 'block';
            document.getElementById('schools-table').style.display = 'none';

            try {
                const response = await auth.fetch('/api/auth/admin/organizations');
                schools = await response.json();

                const tbody = document.getElementById('schools-tbody');
                tbody.innerHTML = schools.map(school => {
                    const now = new Date();
                    const expiresAt = school.expires_at ? new Date(school.expires_at) : null;
                    const isExpired = expiresAt && expiresAt < now;
                    const isActive = school.is_active !== false;
                    const expiresText = expiresAt ? expiresAt.toLocaleDateString() : '<span class="lang-zh">Ê∞∏‰πÖ</span><span class="lang-en">Never</span>';
                    
                    return `
                        <tr style="${!isActive || isExpired ? 'background:#fee;' : ''}">
                            <td><strong>${school.code}</strong></td>
                            <td>${school.name}</td>
                            <td><span class="badge badge-success">${school.invitation_code}</span></td>
                            <td>${expiresText}</td>
                            <td>
                                ${!isActive ? 
                                    '<span class="badge badge-danger">üîí <span class="lang-zh">ÈîÅÂÆö</span><span class="lang-en">Locked</span></span>' : 
                                    isExpired ? 
                                    '<span class="badge badge-danger">‚è∞ <span class="lang-zh">Â∑≤ËøáÊúü</span><span class="lang-en">Expired</span></span>' :
                                    '<span class="badge badge-success">‚úÖ <span class="lang-zh">Ê≠£Â∏∏</span><span class="lang-en">Active</span></span>'
                                }
                            </td>
                            <td>${school.user_count} <span class="lang-zh">Áî®Êà∑</span><span class="lang-en">users</span></td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="editSchool(${school.id})"><span class="lang-zh">ÁºñËæë</span><span class="lang-en">Edit</span></button>
                                <button class="btn btn-danger btn-sm" onclick="deleteSchool(${school.id}, '${school.code}')"><span class="lang-zh">Âà†Èô§</span><span class="lang-en">Delete</span></button>
                            </td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('schools-loading').style.display = 'none';
                document.getElementById('schools-table').style.display = 'table';
            } catch (error) {
                showAlert('Âä†ËΩΩÂ≠¶Ê†°ÂàóË°®Â§±Ë¥• Failed to load schools', 'error');
            }
        }

        async function createSchool() {
            const data = {
                code: document.getElementById('new-school-code').value,
                name: document.getElementById('new-school-name').value
            };

            if (!data.code || !data.name) {
                showAlert('ËØ∑Â°´ÂÜôÂøÖÂ°´Â≠óÊÆµ Please fill required fields', 'error');
                return;
            }

            try {
                await auth.fetch('/api/auth/admin/organizations', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                showAlert('Â≠¶Ê†°ÂàõÂª∫ÊàêÂäü School created successfully', 'success');
                closeModal('create-school-modal');
                loadSchools();
                
                // Clear form
                document.getElementById('new-school-code').value = '';
                document.getElementById('new-school-name').value = '';
                // Invitation code is generated on the server
            } catch (error) {
                showAlert('ÂàõÂª∫Â§±Ë¥• Creation failed: ' + error.message, 'error');
            }
        }

        function editSchool(id) {
            const school = schools.find(s => s.id === id);
            if (!school) return;

            document.getElementById('edit-school-id').value = school.id;
            document.getElementById('edit-school-code').value = school.code;
            document.getElementById('edit-school-name').value = school.name;
            document.getElementById('edit-school-invite').value = school.invitation_code;
            
            // Set expiration date (convert from ISO to YYYY-MM-DD format for date input)
            if (school.expires_at) {
                const date = new Date(school.expires_at);
                document.getElementById('edit-school-expires').value = date.toISOString().split('T')[0];
            } else {
                document.getElementById('edit-school-expires').value = '';
            }
            
            // Set active status
            document.getElementById('edit-school-active').value = school.is_active !== false ? 'true' : 'false';
            
            document.getElementById('edit-school-modal').classList.add('show');
        }

        function regenerateInviteCode() {
            const name = document.getElementById('edit-school-name').value;
            const code = document.getElementById('edit-school-code').value;
            const prefix = (name || code || '').replace(/[^A-Za-z]/g, '').toUpperCase().slice(0, 4).padEnd(4, 'X');
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let suffix = '';
            for (let i = 0; i < 5; i++) {
                suffix += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('edit-school-invite').value = `${prefix}-${suffix}`;
        }

        async function updateSchool() {
            const id = document.getElementById('edit-school-id').value;
            const expiresValue = document.getElementById('edit-school-expires').value;
            
            const data = {
                code: document.getElementById('edit-school-code').value,
                name: document.getElementById('edit-school-name').value,
                invitation_code: document.getElementById('edit-school-invite').value,
                expires_at: expiresValue ? expiresValue : null,  // Convert to null if empty
                is_active: document.getElementById('edit-school-active').value === 'true'
            };

            try {
                await auth.fetch(`/api/auth/admin/organizations/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                showAlert('Â≠¶Ê†°Êõ¥Êñ∞ÊàêÂäü School updated successfully', 'success');
                closeModal('edit-school-modal');
                loadSchools();
            } catch (error) {
                showAlert('Êõ¥Êñ∞Â§±Ë¥• Update failed: ' + error.message, 'error');
            }
        }

        async function deleteSchool(id, code) {
            if (!confirm(`Á°ÆÂÆöÂà†Èô§Â≠¶Ê†° ${code}Ôºü\nAre you sure to delete school ${code}?`)) return;

            try {
                await auth.fetch(`/api/auth/admin/organizations/${id}`, {
                    method: 'DELETE'
                });

                showAlert('Â≠¶Ê†°Âà†Èô§ÊàêÂäü School deleted successfully', 'success');
                loadSchools();
            } catch (error) {
                showAlert('Âà†Èô§Â§±Ë¥• Delete failed: ' + error.message, 'error');
            }
        }

        // Users
        async function loadUsers(page = 1) {
            document.getElementById('users-loading').style.display = 'block';
            document.getElementById('users-table').style.display = 'none';
            document.getElementById('users-pagination').style.display = 'none';

            try {
                // Build query parameters
                const search = document.getElementById('user-search').value.trim();
                const orgId = document.getElementById('user-org-filter').value;
                
                let url = `/api/auth/admin/users?page=${page}&page_size=${usersPageSize}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (orgId) url += `&organization_id=${orgId}`;
                
                const response = await auth.fetch(url);
                const data = await response.json();
                
                users = data.users;
                usersCurrentPage = data.pagination.page;
                usersTotalPages = data.pagination.total_pages;
                usersTotal = data.pagination.total;

                const tbody = document.getElementById('users-tbody');
                tbody.innerHTML = users.map(user => {
                    const isLocked = user.locked_until && new Date(user.locked_until) > new Date();
                    return `
                        <tr>
                            <td>${user.phone}</td>
                            <td>${user.name || '-'}</td>
                            <td>${user.organization_name || '-'} (${user.organization_code || '-'})</td>
                            <td>
                                ${isLocked ? 
                                    '<span class="badge badge-danger">üîí <span class="lang-zh">ÈîÅÂÆö</span><span class="lang-en">Locked</span></span>' : 
                                    '<span class="badge badge-success">‚úÖ <span class="lang-zh">Ê≠£Â∏∏</span><span class="lang-en">Active</span></span>'
                                }
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="showEditUserModal(${user.id})" title="Edit User"><span class="lang-zh">ÁºñËæë</span><span class="lang-en">Edit</span></button>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id}, '${user.phone}')" title="Delete User"><span class="lang-zh">Âà†Èô§</span><span class="lang-en">Delete</span></button>
                                ${isLocked ? 
                                    `<button class="btn btn-success btn-sm" onclick="unlockUser(${user.id}, '${user.phone}')" title="Unlock Account">üîì <span class="lang-zh">Ëß£ÈîÅ</span><span class="lang-en">Unlock</span></button>` : 
                                    ''
                                }
                            </td>
                        </tr>
                    `;
                }).join('');

                // Update pagination info
                updateUsersPagination();

                document.getElementById('users-loading').style.display = 'none';
                document.getElementById('users-table').style.display = 'table';
                document.getElementById('users-pagination').style.display = 'block';
            } catch (error) {
                showAlert('Âä†ËΩΩÁî®Êà∑ÂàóË°®Â§±Ë¥• Failed to load users', 'error');
                console.error(error);
            }
        }
        
        function updateUsersPagination() {
            // Update page info
            const start = (usersCurrentPage - 1) * usersPageSize + 1;
            const end = Math.min(usersCurrentPage * usersPageSize, usersTotal);
            document.getElementById('users-page-info').innerHTML = `
                <span class="lang-zh">ÊòæÁ§∫ ${start}-${end} ÂÖ± ${usersTotal} Êù°</span>
                <span class="lang-en">Showing ${start}-${end} of ${usersTotal}</span>
            `;
            
            // Update prev/next buttons
            document.getElementById('users-prev-btn').disabled = usersCurrentPage === 1;
            document.getElementById('users-next-btn').disabled = usersCurrentPage === usersTotalPages;
            
            // Generate page numbers (show max 5 pages)
            const pageNumbers = document.getElementById('users-page-numbers');
            pageNumbers.innerHTML = '';
            
            let startPage = Math.max(1, usersCurrentPage - 2);
            let endPage = Math.min(usersTotalPages, startPage + 4);
            
            // Adjust start if we're near the end
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = `btn btn-sm ${i === usersCurrentPage ? 'btn-primary' : 'btn-secondary'}`;
                btn.textContent = i;
                btn.onclick = () => gotoUsersPage(i);
                pageNumbers.appendChild(btn);
            }
        }
        
        function filterUsers() {
            usersCurrentPage = 1; // Reset to page 1 when filtering
            loadUsers(1);
        }
        
        function clearUserFilters() {
            document.getElementById('user-search').value = '';
            document.getElementById('user-org-filter').value = '';
            filterUsers();
        }
        
        function previousUsersPage() {
            if (usersCurrentPage > 1) {
                loadUsers(usersCurrentPage - 1);
            }
        }
        
        function nextUsersPage() {
            if (usersCurrentPage < usersTotalPages) {
                loadUsers(usersCurrentPage + 1);
            }
        }
        
        function gotoUsersPage(page) {
            loadUsers(page);
        }
        
        // Load organizations into filter dropdown
        async function loadUserFilters() {
            try {
                const response = await auth.fetch('/api/auth/admin/organizations');
                const orgs = await response.json();
                
                const select = document.getElementById('user-org-filter');
                const currentValue = select.value;
                
                select.innerHTML = '<option value=""><span class="lang-zh">ÂÖ®ÈÉ®Â≠¶Ê†°</span><span class="lang-en">All Schools</span></option>' + 
                    orgs.map(org => `<option value="${org.id}">${org.code} - ${org.name}</option>`).join('');
                
                select.value = currentValue; // Restore selection if any
            } catch (error) {
                console.error('Failed to load organizations for filter:', error);
            }
        }

        async function showEditUserModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                showAlert('User not found', 'error');
                return;
            }

            // Set user data (use real phone for editing)
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-user-phone').value = user.phone_real || user.phone;
            document.getElementById('edit-user-name').value = user.name || '';

            // Load organizations for dropdown
            try {
                const response = await auth.fetch('/api/auth/organizations');
                const orgs = await response.json();
                
                const select = document.getElementById('edit-user-org');
                select.innerHTML = orgs.map(org => {
                    const selected = org.id === user.organization_id ? 'selected' : '';
                    return `<option value="${org.id}" ${selected}>${org.code} - ${org.name}</option>`;
                }).join('');
            } catch (error) {
                showAlert('Failed to load organizations', 'error');
                return;
            }

            openModal('edit-user-modal');
        }

        async function updateUser() {
            const userId = document.getElementById('edit-user-id').value;
            const phone = document.getElementById('edit-user-phone').value.trim();
            const name = document.getElementById('edit-user-name').value.trim();
            const orgId = parseInt(document.getElementById('edit-user-org').value);

            if (!phone || !name || !orgId) {
                showAlert('ÊâÄÊúâÂ≠óÊÆµÂøÖÂ°´ All fields required', 'error');
                return;
            }

            // Validate phone
            if (!/^1\d{10}$/.test(phone)) {
                showAlert('Invalid phone number! Must be 11 digits starting with 1', 'error');
                return;
            }

            // Validate name
            if (/\d/.test(name)) {
                showAlert('Name cannot contain numbers!', 'error');
                return;
            }

            try {
                await auth.fetch(`/api/auth/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: phone,
                        name: name,
                        organization_id: orgId
                    })
                });

                showAlert('Áî®Êà∑Êõ¥Êñ∞ÊàêÂäü User updated successfully', 'success');
                closeModal('edit-user-modal');
                loadUsers();
            } catch (error) {
                showAlert('Êõ¥Êñ∞Â§±Ë¥• Update failed: ' + error.message, 'error');
            }
        }

        async function deleteUser(userId, phone) {
            if (!confirm(`‚ö†Ô∏è Á°ÆÂÆöÂà†Èô§Áî®Êà∑ ${phone}Ôºü\n‚ö†Ô∏è Are you sure to delete user ${phone}?\n\nThis action cannot be undone!`)) {
                return;
            }

            try {
                await auth.fetch(`/api/auth/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                showAlert('Áî®Êà∑Âà†Èô§ÊàêÂäü User deleted successfully', 'success');
                loadUsers();
            } catch (error) {
                showAlert('Âà†Èô§Â§±Ë¥• Delete failed: ' + error.message, 'error');
            }
        }

        async function unlockUser(id, phone) {
            if (!confirm(`Á°ÆÂÆöËß£ÈîÅÁî®Êà∑ ${phone}Ôºü\nUnlock user ${phone}?`)) return;

            try {
                await auth.fetch(`/api/auth/admin/users/${id}/unlock`, {
                    method: 'PUT'
                });

                showAlert('Áî®Êà∑Ëß£ÈîÅÊàêÂäü User unlocked successfully', 'success');
                loadUsers();
            } catch (error) {
                showAlert('Ëß£ÈîÅÂ§±Ë¥• Unlock failed: ' + error.message, 'error');
            }
        }
        
        async function resetPasswordFromModal() {
            const userId = document.getElementById('edit-user-id').value;
            const phone = document.getElementById('edit-user-phone').value;
            
            if (!confirm(`‚ö†Ô∏è Á°ÆÂÆöÈáçÁΩÆËØ•Áî®Êà∑ÁöÑÂØÜÁ†Å‰∏∫ 12345678Ôºü\n‚ö†Ô∏è Reset this user's password to 12345678?\n\nUser: ${phone}\n\nThe user will need to login again with the new password.`)) {
                return;
            }

            try {
                await auth.fetch(`/api/auth/admin/users/${userId}/reset-password`, {
                    method: 'PUT'
                });

                showAlert('ÂØÜÁ†ÅÈáçÁΩÆÊàêÂäü Password reset to 12345678 successfully', 'success');
                closeModal('edit-user-modal');
                loadUsers();
            } catch (error) {
                showAlert('ÂØÜÁ†ÅÈáçÁΩÆÂ§±Ë¥• Password reset failed: ' + error.message, 'error');
            }
        }

        // Enhanced Settings Management
        async function loadEnvSettings() {
            document.getElementById('settings-loading').style.display = 'block';
            document.getElementById('settings-form').style.display = 'none';

            try {
                const response = await auth.fetch('/api/auth/admin/env/settings');
                const data = await response.json();
                const settings = data.settings;

                // Populate all form fields dynamically
                for (const key in settings) {
                    const element = document.getElementById(`env-${key}`);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = settings[key] === 'True' || settings[key] === 'true';
                        } else {
                            element.value = settings[key] || '';
                        }
                    }
                }

                document.getElementById('settings-loading').style.display = 'none';
                document.getElementById('settings-form').style.display = 'block';
            } catch (error) {
                console.error('Failed to load settings:', error);
                showAlert('Failed to load settings: ' + error.message, 'error');
            }
        }

        async function saveEnvSettings() {
            // Collect all settings from form
            const data = {};
            const inputs = document.querySelectorAll('[id^="env-"]');
            
            inputs.forEach(input => {
                const key = input.id.replace('env-', '');
                if (input.type === 'checkbox') {
                    data[key] = input.checked ? 'True' : 'False';
                } else {
                    data[key] = input.value;
                }
            });

            try {
                const response = await auth.fetch('/api/auth/admin/env/settings', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showAlert(`${result.message} - ${result.warning}`, 'warning');
                
                // Reload settings to show updated values
                setTimeout(() => loadEnvSettings(), 1000);
            } catch (error) {
                console.error('Failed to save settings:', error);
                showAlert('Save failed: ' + error.message, 'error');
            }
        }

        async function validateEnvSettings() {
            // Collect all settings from form
            const data = {};
            const inputs = document.querySelectorAll('[id^="env-"]');
            
            inputs.forEach(input => {
                const key = input.id.replace('env-', '');
                if (input.type === 'checkbox') {
                    data[key] = input.checked ? 'True' : 'False';
                } else {
                    data[key] = input.value;
                }
            });

            try {
                const response = await auth.fetch('/api/auth/admin/env/validate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.is_valid) {
                    showAlert('Validation passed! All settings are valid.', 'success');
                } else {
                    showAlert(`Validation errors: ${result.errors.join(', ')}`, 'error');
                }
            } catch (error) {
                console.error('Validation failed:', error);
                showAlert('Validation failed: ' + error.message, 'error');
            }
        }

        async function showBackupListModal() {
            document.getElementById('backup-list-modal').classList.add('show');
            document.getElementById('backup-list-loading').style.display = 'block';
            document.getElementById('backup-list-content').style.display = 'none';

            try {
                const response = await auth.fetch('/api/auth/admin/env/backups');
                const backups = await response.json();

                const tbody = document.getElementById('backup-list-tbody');
                const noBackupsMsg = document.getElementById('no-backups-message');

                if (backups.length === 0) {
                    tbody.innerHTML = '';
                    noBackupsMsg.style.display = 'block';
                } else {
                    noBackupsMsg.style.display = 'none';
                    tbody.innerHTML = backups.map(backup => `
                        <tr>
                            <td><code style="font-size:0.85rem;">${backup.filename}</code></td>
                            <td>${backup.timestamp}</td>
                            <td>${(backup.size_bytes / 1024).toFixed(1)} KB</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="restoreEnvBackup('${backup.filename}')">
                                    Restore
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }

                document.getElementById('backup-list-loading').style.display = 'none';
                document.getElementById('backup-list-content').style.display = 'block';
            } catch (error) {
                console.error('Failed to load backups:', error);
                showAlert('Failed to load backups: ' + error.message, 'error');
                closeModal('backup-list-modal');
            }
        }

        async function restoreEnvBackup(filename) {
            if (!confirm(`Restore .env from backup: ${filename}?\n\nCurrent .env will be backed up before restoration.`)) {
                return;
            }

            try {
                const response = await auth.fetch(`/api/auth/admin/env/restore?backup_filename=${encodeURIComponent(filename)}`, {
                    method: 'POST'
                });

                const result = await response.json();
                showAlert(`${result.message} - ${result.warning}`, 'success');
                
                // Close modal and reload settings
                closeModal('backup-list-modal');
                setTimeout(() => loadEnvSettings(), 1000);
            } catch (error) {
                console.error('Failed to restore backup:', error);
                showAlert('Restore failed: ' + error.message, 'error');
            }
        }

        function toggleCategory(categoryId) {
            const content = document.getElementById(`${categoryId}-content`);
            const icon = document.getElementById(`${categoryId}-icon`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.textContent = '‚ñº';
            } else {
                content.classList.add('collapsed');
                icon.textContent = '‚ñ∂';
            }
        }

        // API Keys
        let apiKeys = [];

        async function loadAPIKeys() {
            document.getElementById('apikeys-loading').style.display = 'block';
            document.getElementById('apikeys-table').style.display = 'none';

            try {
                const response = await auth.fetch('/api/auth/admin/api_keys');
                apiKeys = await response.json();

                const tbody = document.getElementById('apikeys-tbody');
                tbody.innerHTML = apiKeys.map(key => {
                    const isExpired = key.expires_at && new Date(key.expires_at) < new Date();
                    const usagePercent = key.usage_percentage || 0;
                    const quotaText = key.quota_limit ? `${key.usage_count.toLocaleString()} / ${key.quota_limit.toLocaleString()}` : `${key.usage_count.toLocaleString()} / unlimited`;
                    
                    return `
                        <tr>
                            <td>
                                <strong>${key.name}</strong>
                                ${key.description ? `<br><small style="color:#64748b;">${key.description}</small>` : ''}
                            </td>
                            <td>
                                <code style="font-size:0.75rem;background:#f1f5f9;padding:0.25rem 0.5rem;border-radius:4px;" onclick="copyToClipboard('${key.key}', this)">${key.key.substring(0, 20)}...${key.key.substring(key.key.length - 8)}</code>
                            </td>
                            <td>
                                ${quotaText}
                                ${key.quota_limit ? `<br><div style="background:#e2e8f0;height:6px;border-radius:3px;margin-top:4px;overflow:hidden;"><div style="background:${usagePercent > 90 ? '#ef4444' : '#667eea'};width:${Math.min(usagePercent, 100)}%;height:100%;"></div></div>` : ''}
                            </td>
                            <td>
                                ${key.is_active && !isExpired ? 
                                    '<span class="badge badge-success">‚úÖ <span class="lang-zh">ÊøÄÊ¥ª</span><span class="lang-en">Active</span></span>' : 
                                    isExpired ? '<span class="badge badge-danger">‚è∞ <span class="lang-zh">ËøáÊúü</span><span class="lang-en">Expired</span></span>' :
                                    '<span class="badge badge-danger">‚ùå <span class="lang-zh">Á¶ÅÁî®</span><span class="lang-en">Disabled</span></span>'
                                }
                            </td>
                            <td><small>${new Date(key.created_at).toLocaleDateString()}</small></td>
                            <td><small>${key.last_used_at ? new Date(key.last_used_at).toLocaleString() : 'Never'}</small></td>
                            <td>
                                <button class="btn btn-sm ${key.is_active ? 'btn-secondary' : 'btn-success'}" onclick="toggleAPIKey(${key.id})">${key.is_active ? '‚è∏Ô∏è <span class="lang-zh">Á¶ÅÁî®</span><span class="lang-en">Disable</span>' : '‚ñ∂Ô∏è <span class="lang-zh">ÂêØÁî®</span><span class="lang-en">Enable</span>'}</button>
                                <button class="btn btn-primary btn-sm" onclick="editAPIKey(${key.id})"><span class="lang-zh">ÁºñËæë</span><span class="lang-en">Edit</span></button>
                                <button class="btn btn-danger btn-sm" onclick="deleteAPIKey(${key.id}, '${key.name}')"><span class="lang-zh">Âà†Èô§</span><span class="lang-en">Delete</span></button>
                            </td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('apikeys-loading').style.display = 'none';
                document.getElementById('apikeys-table').style.display = 'table';
            } catch (error) {
                showAlert('Failed to load API keys: ' + error.message, 'error');
            }
        }

        function showCreateAPIKeyModal() {
            document.getElementById('create-apikey-modal').classList.add('show');
        }

        async function createAPIKey() {
            const data = {
                name: document.getElementById('new-apikey-name').value,
                description: document.getElementById('new-apikey-description').value,
                quota_limit: document.getElementById('new-apikey-quota').value ? parseInt(document.getElementById('new-apikey-quota').value) : null,
                expires_days: document.getElementById('new-apikey-expires').value ? parseInt(document.getElementById('new-apikey-expires').value) : null
            };

            if (!data.name) {
                showAlert('Please enter a name for the API key', 'error');
                return;
            }

            try {
                const response = await auth.fetch('/api/auth/admin/api_keys', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                // Show the generated key
                document.getElementById('generated-apikey').value = result.key;
                closeModal('create-apikey-modal');
                document.getElementById('show-apikey-modal').classList.add('show');
                
                // Clear form
                document.getElementById('new-apikey-name').value = '';
                document.getElementById('new-apikey-description').value = '';
                document.getElementById('new-apikey-quota').value = '';
                document.getElementById('new-apikey-expires').value = '';
                
                showAlert(result.message, 'success');
                loadAPIKeys();
            } catch (error) {
                showAlert('Failed to create API key: ' + error.message, 'error');
            }
        }

        function copyAPIKey() {
            const apiKeyInput = document.getElementById('generated-apikey');
            apiKeyInput.select();
            navigator.clipboard.writeText(apiKeyInput.value);
            showAlert('API key copied to clipboard! üìã', 'success');
        }

        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text);
            const originalText = element.innerHTML;
            element.innerHTML = '‚úÖ Copied!';
            element.style.background = '#d1fae5';
            element.style.color = '#065f46';
            setTimeout(() => {
                element.innerHTML = originalText;
                element.style.background = '#f1f5f9';
                element.style.color = '';
            }, 2000);
        }

        function editAPIKey(id) {
            const key = apiKeys.find(k => k.id === id);
            if (!key) return;

            document.getElementById('edit-apikey-id').value = key.id;
            document.getElementById('edit-apikey-name').value = key.name;
            document.getElementById('edit-apikey-description').value = key.description || '';
            document.getElementById('edit-apikey-quota').value = key.quota_limit || '';
            document.getElementById('edit-apikey-usage').value = key.usage_count;
            
            document.getElementById('edit-apikey-modal').classList.add('show');
        }

        async function updateAPIKey() {
            const id = document.getElementById('edit-apikey-id').value;
            const data = {
                name: document.getElementById('edit-apikey-name').value,
                description: document.getElementById('edit-apikey-description').value,
                quota_limit: document.getElementById('edit-apikey-quota').value ? parseInt(document.getElementById('edit-apikey-quota').value) : null,
                usage_count: parseInt(document.getElementById('edit-apikey-usage').value)
            };

            try {
                await auth.fetch(`/api/auth/admin/api_keys/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                showAlert('API key updated successfully', 'success');
                closeModal('edit-apikey-modal');
                loadAPIKeys();
            } catch (error) {
                showAlert('Failed to update API key: ' + error.message, 'error');
            }
        }

        async function toggleAPIKey(id) {
            try {
                const response = await auth.fetch(`/api/auth/admin/api_keys/${id}/toggle`, {
                    method: 'PUT'
                });

                const result = await response.json();
                showAlert(result.message, 'success');
                loadAPIKeys();
            } catch (error) {
                showAlert('Failed to toggle API key: ' + error.message, 'error');
            }
        }

        async function deleteAPIKey(id, name) {
            if (!confirm(`‚ö†Ô∏è Delete API key "${name}"?\n\nThis action cannot be undone and will immediately revoke access.`)) return;

            try {
                const response = await auth.fetch(`/api/auth/admin/api_keys/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                showAlert(result.message, 'success');
                loadAPIKeys();
            } catch (error) {
                showAlert('Failed to delete API key: ' + error.message, 'error');
            }
        }

        function logout() {
            if (confirm('Á°ÆÂÆöÁôªÂá∫Ôºü\nAre you sure to logout?')) {
                auth.logout();
            }
        }

        // Log Viewer Integration Functions
        function initLogViewer() {
            logViewer.init();
        }
        
        function toggleLogStream() {
            if (logViewer.eventSource) {
                logViewer.stopStreaming();
            } else {
                logViewer.startStreaming();
            }
        }
        
        function performLogSearch() {
            const query = document.getElementById('log-search-input').value;
            if (query && query.trim() !== '') {
                logViewer.searchLogs(query.trim());
            }
        }
        
        function clearLogSearch() {
            document.getElementById('log-search-input').value = '';
            const countEl = document.getElementById('search-results-count');
            if (countEl) {
                countEl.style.display = 'none';
            }
            logViewer.setSearchQuery('');
            logViewer.loadInitialLogs();
        }

        // Initialize
        loadDashboard();
    </script>
    
    <!-- Admin Log Viewer Script -->
    <script src="/static/js/admin-logs.js"></script>
</body>
</html>

