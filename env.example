# ============================================================================
# MINDPHASE ENVIRONMENT CONFIGURATION
# ============================================================================
# Copy this file to .env and configure according to your deployment needs

# ============================================================================
# APPLICATION CONFIGURATION
# ============================================================================
HOST=0.0.0.0
PORT=9527
DEBUG=False

# Optional: Set your public WAN IP for external access (auto-detected if not set)
# EXTERNAL_HOST=your-public-ip-address

# Optional: Full base URL for external access (takes precedence over EXTERNAL_HOST)
# Use this when behind a reverse proxy with HTTPS (e.g. Nginx Proxy Manager)
# Example: https://your-domain.com (no trailing slash)
# EXTERNAL_BASE_URL=https://your-domain.com

# ============================================================================
# CORE LLM CONFIGURATION
# ============================================================================

# Qwen API (Required)
QWEN_API_KEY=your-qwen-api-key-here
QWEN_API_URL=https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions

# Model Selection (IMPORTANT: Use high RPM versions!)
# qwen-turbo: 1,200 RPM - good for classification
# qwen-plus-latest: 15,000 RPM - recommended for generation
# AVOID dated versions like qwen-plus-2025-12-01 (only 60 RPM!)
QWEN_MODEL_CLASSIFICATION=qwen-turbo
QWEN_MODEL_GENERATION=qwen-plus-latest

QWEN_TEMPERATURE=0.7
QWEN_MAX_TOKENS=1000
QWEN_TIMEOUT=40

# Unified temperature for diagram generation (0.1-0.3 for JSON, 0.7-1.0 for creative)
LLM_TEMPERATURE=0.3

# Tencent Hunyuan API (Optional)
# Register at: https://cloud.tencent.com/product/hunyuan
# Note: Temperature must be ≤ 2.0
HUNYUAN_API_KEY=your-hunyuan-secretkey-here
HUNYUAN_SECRET_ID=your-hunyuan-secretid-here
HUNYUAN_API_URL=https://hunyuan.tencentcloudapi.com
HUNYUAN_MODEL=hunyuan-turbo
HUNYUAN_TEMPERATURE=1.0
HUNYUAN_MAX_TOKENS=2000

# ============================================================================
# VOLCENGINE ARK API CONFIGURATION
# ============================================================================
# Register at: https://www.volcengine.com/product/doubao
# Uses OpenAI-compatible API (ARK)
# IMPORTANT: Use endpoint IDs for higher RPM limits!

ARK_API_KEY=your-ark-api-key-here
ARK_BASE_URL=https://ark.cn-beijing.volces.com/api/v3

# Volcengine Endpoint IDs (Higher RPM than direct model names!)
# Create endpoints in Volcengine ARK Console: https://console.volcengine.com/ark
ARK_QWEN_ENDPOINT=ep-20251222212931-hjqh2
ARK_DEEPSEEK_ENDPOINT=ep-20251222212434-cxpzb
ARK_KIMI_ENDPOINT=ep-20251222212350-wxbks
ARK_DOUBAO_ENDPOINT=ep-20251222212319-qqzb7

# Legacy model name (fallback if endpoint not available)
DOUBAO_MODEL=doubao-1-5-pro-32k-250115

# ============================================================================
# LOAD BALANCING CONFIGURATION
# ============================================================================
# Distributes LLM requests between Dashscope and Volcengine providers
# to maximize throughput and avoid rate limiting bottlenecks

# Enable/disable load balancing (default: false for backward compatibility)
LOAD_BALANCING_ENABLED=true

# Strategy: 'weighted', 'round_robin', 'random'
# Recommended: 'weighted' for multi-worker environments
LOAD_BALANCING_STRATEGY=weighted

# Weight distribution (must sum to 100)
# Route A: Dashscope (qwen, deepseek) + Volcengine (kimi, doubao)
# Route B: Full Volcengine (all models)
# 30% Route A, 70% Route B (Volcengine has higher capacity)
LOAD_BALANCING_WEIGHTS=route_a:30,route_b:70

# ============================================================================
# DASHSCOPE RATE LIMITING
# ============================================================================
# Actual per-model limits from Aliyun Bailian Console:
#   qwen-plus-latest: 15,000 RPM
#   deepseek-v3.1: 15,000 RPM
#   qwen-turbo: 1,200 RPM
#   Moonshot-Kimi-K2: 60 RPM (BOTTLENECK - we use Volcengine for Kimi!)
#
# With load balancing, we avoid the Kimi bottleneck entirely!
# Safe limit: 10,000 QPM (below the 15,000 RPM of qwen/deepseek)

DASHSCOPE_QPM_LIMIT=10000
DASHSCOPE_CONCURRENT_LIMIT=500
DASHSCOPE_RATE_LIMITING_ENABLED=false

# ============================================================================
# VOLCENGINE RATE LIMITING
# ============================================================================
# Actual per-model limits from Volcengine Console:
#   Doubao: 30,000 RPM (highest)
#   DeepSeek: 15,000 RPM
#   Kimi: 5,000 RPM (83x better than Dashscope's 60 RPM!)
#   Qwen3-14B: Elastic (4,200 TPS)
#
# With such high limits, rate limiting is optional.
# Safe limit: 5,000 QPM (based on ark-kimi, the lowest)

ARK_QPM_LIMIT=5000
ARK_CONCURRENT_LIMIT=500
ARK_RATE_LIMITING_ENABLED=false

# Qwen Omni Realtime (Voice Agent)
QWEN_OMNI_MODEL=qwen3-omni-flash-realtime-2025-12-01
QWEN_OMNI_VOICE=Cherry
QWEN_OMNI_VAD_THRESHOLD=0.5
QWEN_OMNI_VAD_SILENCE_MS=1200
QWEN_OMNI_VAD_PREFIX_MS=300
QWEN_OMNI_SMOOTH_OUTPUT=true
QWEN_OMNI_INPUT_FORMAT=pcm16
QWEN_OMNI_OUTPUT_FORMAT=pcm24
QWEN_OMNI_TRANSCRIPTION_MODEL=gummy-realtime-v1

# ============================================================================
# UI & DISPLAY CONFIGURATION
# ============================================================================
GRAPH_LANGUAGE=zh
DEFAULT_LANGUAGE=zh
TOPIC_FONT_SIZE=18
CHAR_FONT_SIZE=14
WATERMARK_TEXT=MindGraph

# ============================================================================
# LOGGING & DEBUGGING
# ============================================================================
LOG_LEVEL=INFO
VERBOSE_LOGGING=False

# ============================================================================
# FEATURE FLAGS
# ============================================================================
FEATURE_MINDMATE=False
FEATURE_VOICE_AGENT=False
FEATURE_DRAG_AND_DROP=False
FEATURE_TAB_MODE=False

# ============================================================================
# AI ASSISTANT CONFIGURATION
# ============================================================================
DIFY_API_KEY=your_dify_api_key_here
DIFY_API_URL=http://101.42.231.179/v1
DIFY_TIMEOUT=30
AI_ASSISTANT_NAME=教学设计

# ============================================================================
# DATABASE CONFIGURATION
# ============================================================================
DATABASE_URL=sqlite:///./data/mindgraph.db

# Database Connection Pool Configuration
# SQLite defaults (for 200 concurrent users with 3x safety margin):
# - pool_size=15, max_overflow=30, total=45 connections
# PostgreSQL/MySQL defaults (for 6 workers):
# - pool_size=30, max_overflow=60, total=90 connections
# Increase if you see "QueuePool limit reached" errors
# DATABASE_POOL_SIZE=15
# DATABASE_MAX_OVERFLOW=30
# DATABASE_POOL_TIMEOUT=30

# ============================================================================
# TOKEN TRACKING CONFIGURATION
# ============================================================================
# Optimized for high concurrency (50-200+ users)
# Uses memory-first batching to minimize SQLite write contention

# Enable/disable token tracking entirely (default: true)
TOKEN_TRACKER_ENABLED=true

# Batch size: flush buffer when it reaches this many records (default: 1000)
# Higher = fewer DB writes, but more memory usage and data loss risk on crash
TOKEN_TRACKER_BATCH_SIZE=1000

# Batch interval: flush buffer after this many seconds (default: 300 = 5 minutes)
# Works with batch size: whichever triggers first causes a flush
TOKEN_TRACKER_BATCH_INTERVAL=300

# Max buffer size: force flush if buffer exceeds this (default: 10000)
# Safety limit to prevent out-of-memory in extreme load scenarios
TOKEN_TRACKER_MAX_BUFFER_SIZE=10000

# ============================================================================
# DATABASE BACKUP CONFIGURATION
# ============================================================================
BACKUP_ENABLED=true
BACKUP_HOUR=3
BACKUP_RETENTION_COUNT=2
BACKUP_DIR=backup

# ============================================================================
# TENCENT CLOUD OBJECT STORAGE (COS) CONFIGURATION (Optional)
# ============================================================================
# Register at: https://console.cloud.tencent.com/cos5
# Uses same credentials as SMS (TENCENT_SMS_SECRET_ID, TENCENT_SMS_SECRET_KEY)
COS_BACKUP_ENABLED=false
COS_BUCKET=your-bucket-name-appid
COS_REGION=ap-beijing
# Use different prefixes for different environments (e.g., backups/mindgraph-Master)
COS_KEY_PREFIX=backups/mindgraph-CHANGE

# ============================================================================
# AUTHENTICATION & SECURITY CONFIGURATION
# ============================================================================
# Generate secure key: python -c "import secrets; print(secrets.token_urlsafe(48))"
JWT_SECRET_KEY=QwWZfgwi-ct3rBdWyhoXa7S5mzHuC6yaGgmzGC_-1qSMl4H-879Ng4jZIq1cBSR7
JWT_EXPIRY_HOURS=24

# Auth modes: standard, enterprise, demo, bayi
AUTH_MODE=standard
# Admin phone numbers (comma-separated). After registering with invitation code, add your phone here and restart server
# Example: ADMIN_PHONES=13812345678,13987654321
ADMIN_PHONES=

# Enterprise Mode (only if AUTH_MODE=enterprise)
ENTERPRISE_DEFAULT_ORG_CODE=DEMO-001
ENTERPRISE_DEFAULT_USER_PHONE=enterprise@system.com

# Demo Mode (only if AUTH_MODE=demo)
DEMO_PASSKEY=888888
ADMIN_DEMO_PASSKEY=999999

# Bayi Mode (only if AUTH_MODE=bayi)
BAYI_DECRYPTION_KEY=v8IT7XujLPsM7FYuDPRhPtZk
BAYI_DEFAULT_ORG_CODE=BAYI-001
BAYI_CLOCK_SKEW_TOLERANCE=10
BAYI_IP_WHITELIST=

# Invitation Codes: Format AAAA-XXXXX (4 uppercase letters, dash, 5 uppercase letters/digits)
# Internal format: ORG_CODE:INVITATION_CODE:EXPIRY_DATE (expiry optional, defaults to "never")
# Users only need the invitation code (e.g., DEMO-A1B2C) to register
INVITATION_CODES=DEMO-001:DEMO-A1B2C:never

# ============================================================================
# TENCENT CLOUD SMS CONFIGURATION (Optional)
# ============================================================================
# Register at: https://console.cloud.tencent.com/smsv2
TENCENT_SMS_SECRET_ID=your-tencent-secret-id-here
TENCENT_SMS_SECRET_KEY=your-tencent-secret-key-here
TENCENT_SMS_SDK_APP_ID=1400000000
TENCENT_SMS_SIGN_NAME=MindGraph
TENCENT_SMS_REGION=ap-guangzhou
TENCENT_SMS_TEMPLATE_REGISTER=1234567
TENCENT_SMS_TEMPLATE_LOGIN=1234568
TENCENT_SMS_TEMPLATE_RESET_PASSWORD=1234569

# SMS Rate Limiting
SMS_CODE_EXPIRY_MINUTES=5
SMS_RESEND_INTERVAL_SECONDS=60
SMS_MAX_ATTEMPTS_PER_PHONE=5
SMS_MAX_ATTEMPTS_WINDOW_HOURS=1
SMS_MAX_CONCURRENT_REQUESTS=10
SMS_QPM_LIMIT=100
SMS_RATE_LIMITING_ENABLED=true

# ============================================================================
# REDIS CONFIGURATION (REQUIRED)
# ============================================================================
# MindGraph uses SQLite + Redis architecture:
#   - SQLite: Persistent data (users, organizations, token history)
#   - Redis: Ephemeral data (captcha, rate limiting, sessions, buffers)
#
# Redis is REQUIRED. Application will NOT start without Redis.

# Redis connection URL (default: redis://localhost:6379/0)
REDIS_URL=redis://localhost:6379/0

# Connection pool settings (optional)
# REDIS_MAX_CONNECTIONS=50
# REDIS_SOCKET_TIMEOUT=5

# To start Redis on Ubuntu:
#   sudo apt install redis-server
#   sudo systemctl start redis-server
#   sudo systemctl enable redis-server  # auto-start on boot
#
# To start Redis with Docker:
#   docker run -d --name redis -p 6379:6379 redis:alpine

# ============================================================================
# REVERSE PROXY CONFIGURATION
# ============================================================================
# For Nginx Proxy Manager, add in Advanced > Custom Nginx Configuration:
# proxy_set_header X-Real-IP $remote_addr;
# proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
# proxy_set_header X-Forwarded-Proto $scheme;
# TRUSTED_PROXY_IPS=10.0.0.1,192.168.1.100

# ============================================================================
# EXTERNAL SERVICES CONFIGURATION
# ============================================================================
WECHAT_QR_IMAGE=
